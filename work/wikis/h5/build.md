# 构建和发布

## 自动化脚本
* 普通构建：./build.sh
* 增量构建：./addition.build.sh
* 参数构建：./params.build.sh

## 构建
* 普通构建
	* 会将原先构建的代码删除掉，会导致的情况是，有人正在使用h5，主入口文件已经加载，这个时候上线的话就会把老的文件删除掉，用户就访问不到更新过的页面，为了解决这个问题，提出了增量构建的方式
* 增量构建
	* 原理，改造原有的发布脚本，先将上一个版本的发布文件复制到缓存目录，再构建当前版本的发布文件，构建完成后，从发布目录将上一个版本的文件拷贝回发布目录
	* 执行脚本 `./addition.build.sh`
* 增量构建（参数版本）
	* 原理，执行脚本时所带的参数（标签名、分支名），从前往后复制代码并覆盖，构建出来的代码以最后一个参数版本的代码为基础，并包含前面所有参数版本的代码
	* 执行脚本示例 `./params.build.sh v0.2.0 v0.2.3 new` ，至少包含两个参数，参数为标签名或分支名，最后一个参数为最新版本的代码
* 尽量使用增量构建发布上线，如需使用普通构建，则请在用户访问量极少的时间段上线
* 使用以上构建脚本构建时，可以在命令行后添加参数 `--cdn=index`，来给静态资源添加 `cdn` 前缀
	* 如果不添加此参数，则静态资源默认访问路径为 `./`
	* `index` 为预先设置的 `cdn` 前缀数组的下标
	* `cdn` 前缀数组配置在 `./config/index.js` 文件中

## 发布和上线流程
* 发布
  * 先提交自己对源文件的修改，此为一个提交记录
	* 再构建发布代码，提交一个信息为 `build` 的记录
* 上线
	* 修改 ./src/main.js 和 ./package.json 修改版本号，关于版本号的确定，请参考[语义化版本](http://semver.org/lang/zh-CN/)
	* 和发布中所描述的一样，先提交源文件的修改，并写明版本号更改信息
	* 再构建发布代码，小版本使用`增量构建`，大版本使用`参数构建`（构建当前版本和上一个版本的代码），提交格式为`build - 版本号`
	* 到 http://git.fond.io/dsq/kakajie-h5/tags 打 tag
	* 到发布系统上线对应 tag 的代码（发布系统需要权限，如有需要，另请相关人员授权）

## 参考
* [语义化版本](http://semver.org/lang/zh-CN/)